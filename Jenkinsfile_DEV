// Current Working:-->edit1
pipeline {
    agent any

    environment {
        DOWNLOAD_DIRECTORY = "${env.WORKSPACE}\\${ApplicationName}" // Directory for downloaded repo
        TEMP_ZIP_PATH = "${env.WORKSPACE}\\${ApplicationName}\\temp_package.zip" // Path for initial ZIP file
        FINAL_ZIP_NAME = "${ApplicationName}.23362.zip" // Final ZIP file name
        FINAL_ZIP_PATH = "${env.WORKSPACE}\\${ApplicationName}\\${ApplicationName}.23362.zip"
        REMOTE_SERVER = "blackduck@blackduckfiles.ebiz.domain.com"
        REMOTE_PATH = ":"
        PASSWORD = "upload"
    }

    stages {
        stage('Prepare Download Directory') {
            steps {
                script {
                    // Clear download directory if it already exists
                    bat """
                        IF EXIST "${DOWNLOAD_DIRECTORY}" (rmdir /S /Q "${DOWNLOAD_DIRECTORY}")
                        mkdir "${DOWNLOAD_DIRECTORY}"
                    """
                }
                bat """
                    echo Current Directory after Prepare: %cd%
                    dir "%cd%"
                """
            }
        }

        stage('Clone Git Repository') {
            steps {
                // Clone repository (Git info managed by Jenkins)
                checkout scm
                bat """
                    echo Current Directory after Clone: %cd%
                    dir "%cd%"
                """
            }
        }

        stage('Package as ZIP') {
            steps {
                script {
                    // Verify the directory to be zipped exists and contains files
                    bat """
                        echo Checking contents of ${DOWNLOAD_DIRECTORY}
                        
                        
                    """

                    // Create initial ZIP file from downloaded directory
                    bat """
                        powershell -Command "Compress-Archive -Path '${env.WORKSPACE}' -DestinationPath '${env.WORKSPACE}\\${ApplicationName}\\temp_package.zip'"
                    """

                    // Confirm ZIP file was created and has content
                    bat """
                        IF EXIST "${TEMP_ZIP_PATH}" (
                            echo ZIP file created successfully at ${TEMP_ZIP_PATH}
                        ) ELSE (
                            echo ERROR: ZIP file was not created. Exiting stage.
                            EXIT /B 1
                        )
                    """

                    // Rename the ZIP file to the required name
                    bat """
                        rename "${TEMP_ZIP_PATH}" "${FINAL_ZIP_NAME}"
                    """
                }
                bat """
                    echo Current Directory after Packaging: %cd%
                    dir "%cd%"
                """
            }
        }


        stage('Archive ZIP as Artifact') {
            steps {
                // Archive the final ZIP file in Jenkins as an artifact
                archiveArtifacts artifacts: "${FINAL_ZIP_PATH}", allowEmptyArchive: false
                bat """
                    echo Current Directory after Archive: %cd%
                    echo final zip path ${FINAL_ZIP_PATH}
                    dir "%cd%"
                """
            }
        }
    }

    post {
        always {
            echo "Download, packaging, transfer, and archive completed."
        }
    }
}
